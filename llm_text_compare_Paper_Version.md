# LLM-Text-Compare — Бумажная версия: роли и промпты (v1.0)

**Цель.** Сравнение и слияние разноструктурных текстов на общую тему без кода: извлечение тезисов, нормализация терминов, сопоставление, судейство, проверка, синтез и аудит. Все шаги выполняются в отдельных LLM‑сессиях по строгим инструкциям, с обменом артефактами вручную.

---

## 0. Глобальные правила и артефакты

**Принципы.** Нулевая толерантность к фантазиям; работа строго с переданными текстами и явно процитированными внешними источниками; все факты маркируются и журналируются; стиль — информативный, без риторики.

**Единица работы.** Тезис (claim) в формате Тульмина: `claim, evidence_inline, scope{time|jurisdiction|conditions}, facts[F#], origin, notes`.

**Артефакты проекта.**
- `claims.tsv` — все тезисы (после экстракции и последующей нормализации).
- `term_map.tsv` — канонический «термбанк» с алиасами.
- `pairs.tsv` — список пар тезисов-кандидатов для сопоставления.
- `judgments.tsv` — слепое парное судейство (A/B) по критериям.
- `evidence.tsv` — результаты CoVe-проверок (claim ↔ source ↔ статус).
- `consistency.tsv` — результаты SelfCheck (стабильность/расхождения).
- `conflicts.md` — карта конфликтов и их типизация.
- `Merged.md` — итоговое слияние (подтверждённые/условные тезисы).
- `Audit.md` — журнал удалений, отклонений, конфликтов, открытых вопросов.
- (опц.) `claim_ledger.json` — машинночитаемый реестр тезисов.

**Стоп‑условия.** Синтез разрешён только после: (i) заполнены `evidence.tsv` и `consistency.tsv` по спорным зонам, (ii) в `conflicts.md` нет «неразобранных» истинных противоречий.

---

## 00. Оркестратор (управление процессом)
**Задача.** Обеспечить дисциплину протокола и неизменность шаблонов; анонимизация A/B; ручная рандомизация порядка.

**Промпт.**
> Ты — Оркестратор. Проверь соответствие артефактов требованиям и целостность ссылок между файлами. Запрети переход к следующему этапу при отсутствии обязательных полей или несогласованных ссылок (id/origin). Выведи краткий отчёт о готовности со списком блокеров.

**Чек‑лист.** Идентификаторы уникальны; `origin` указывает документ и позицию; все `[F#]` перечислены; `scope` заполнен; `term_map.tsv` не пуст.

---

## 01. Extractor — извлечение тезисов
**Вход.** `A.md`, `B.md` (и др.).  
**Выход.** Черновой `claims.tsv`.

**Инструкция.**
> Извлеки содержательные тезисы из каждого документа. Игнорируй вводные, примеры, метафоры без доказательной функции. Для каждого тезиса оформи карточку:
> `id | claim | evidence_inline | scope.time | scope.jurisdiction | scope.conditions | facts | origin | notes`
> Где `facts` — список маркеров `F1; F2; …` на фактуальные атомы (числа, даты, имена, источники). В `origin` укажи документ и ориентир (абзац/заголовок). Никакого внешнего знания и обобщений.

**Критерии качества.** Полнота содержательных тезисов; отсутствие риторики; явные границы применимости.

---

## 02. Normalizer — терминологическое выравнивание
**Вход.** Черновой `claims.tsv`.  
**Выход.** Обновлённый `claims.tsv` + `term_map.tsv`.

**Инструкция.**
> Построй `term_map.tsv` со столбцами: `canonical | variants | lang | definition_source | notes`. Подбери для каждого встречного термина каноническую лемму; укажи алиасы (включая кальки и многоязычные эквиваленты). Перепиши поле `claim` каждой записи в `claims.tsv` так, чтобы использовались только `canonical`‑формы. Алиасы сохрани в `notes`. Единицы измерения и обозначения унифицируй (SI; ISO формат дат). Определи типы сущностей (сущность/процедура/метрика/организация/дата).

**Критерии качества.** Никаких смысловых сдвигов; все термины имеют канон и список алиасов; временные/юрисдикционные поля нормализованы.

---

## 03. Blocking — формирование пар‑кандидатов
**Вход.** Нормализованный `claims.tsv`, `term_map.tsv`.  
**Выход.** `pairs.tsv` (кандидаты для сопоставления).

**Инструкция.**
> Сформируй пары тезисов, потенциально относящихся к одной теме, по совпадению ключей: (i) хотя бы один общий `canonical` термин или сущность; (ii) пересечение `scope.time` или общей `jurisdiction`; (iii) совпадение метрики/единиц. Выведи `pairs.tsv`:
> `pair_id | A_id | B_id | matched_keys | scope_overlap | comments`.

**Критерии качества.** Высокий recall при умеренном precision (лучше больше кандидатов, чем пропуск).

---

## 04. Aligner/NLI — типизация отношений между тезисами
**Вход.** `pairs.tsv`, `claims.tsv`.  
**Выход.** Обновлённый `pairs.tsv` с полями отношений; `conflicts.md`.

**Инструкция.**
> Для каждой пары A/B определи отношение: `equivalent | refines (A уточняет B) | extends (A дополняет B) | contradicts | independent`. Дай краткое обоснование с цитатами (по идентификаторам `A_id/B_id` и кусками `claim`). Дополнительно отметь логико‑семантический статус: `entails / contradicts / neutral` и причину (NLI‑уровень). Если `contradicts`, классифицируй конфликт: `истинный (общая область/время) | кажущийся (разные условия/определения) | псевдо (лексика)`. Сводку конфликтов перенеси в `conflicts.md`.

**Формат записи в `pairs.tsv`.**
`pair_id | A_id | B_id | relation | nli | rationale | conflict_type | condition_notes`.

**Критерии качества.** Обоснование опирается на тексты A/B; точная классификация конфликтов по области/времени/условиям.

---

## 05. Judge — слепое парное судейство (A/B)
**Вход.** Пары из `pairs.tsv` (включая `equivalent/refines/extends/contradicts`) и исходные тексты соответствующих тезисов.  
**Выход.** `judgments.tsv` с итогами по критериям.

**Инструкция (буквально вставлять).**
> Ты — Судья. Сравни A и B **только по содержанию**. Игнорируй стиль, объём, «наукообразие». Оцени по критериям (да/нет + 1 строка причины):
> C1 Корректность и непротиворечивость; C2 Полнота по вопросу; C3 Логическая связность; C4 Проверяемость (есть факты/ссылки). Итог: `A лучше | B лучше | ничья`. Не упоминай метаданные, не гадай об источниках.

**Процедура.** Оркестратор анонимизирует и рандомизирует порядок; Судья работает «вслепую». Дубликатный прогон с инверсией порядка обязательный.

**Формат `judgments.tsv`.** `pair_id | winner | C1 | C2 | C3 | C4 | notes`.

---

## 06. Verifier — Chain‑of‑Verification (CoVe)
**Вход.** Спорные пары/кластеры из `pairs.tsv` и `conflicts.md`.  
**Выход.** `evidence.tsv`.

**Инструкция (буквально вставлять).**
> Составь 3–7 проверочных вопросов по спорным тезисам. На каждый ответь отдельно. Для каждого ответа укажи: `claim_id`, `вопрос`, `статус: supported/refuted/uncertain`, `источник (название/URL)`, `дата публикации/обновления`, краткую **цитату** (до 30 слов). Если источники противоречат, отметь это явно.

**Формат `evidence.tsv`.** `claim_id | question | status | source | date | quote`.

**Политика.** В итог пойдут только `supported` и `conditional` (при чётко обозначенных условиях).

---

## 07. SelfCheck — устойчивость формулировок
**Вход.** Тезисы без внешних источников, либо отмеченные как спорные.  
**Выход.** `consistency.tsv`.

**Инструкция.**
> Сгенерируй 5 перефразов каждого целевого тезиса. Сопоставь фактуальные атомы `[F#]`. Выяви расхождения (числа, даты, имена, причинно‑следственные связи). Если хотя бы один факт меняется или противоречит, пометь тезис как `uncertain` и перечисли конфликтующие элементы.

**Формат.** `claim_id | variants_diff | unstable_facts | decision`.

---

## 08. Synthesizer — слияние и обогащение
**Вход.** `claims.tsv`, `pairs.tsv`, `judgments.tsv`, `evidence.tsv`, `consistency.tsv`, `conflicts.md`.  
**Выход.** `Merged.md`.

**Инструкция.**
> Собери итоговый текст как композицию инвариантов (пересечение эквивалентных тезисов) и совместимых дополнений. Принципы включения:
> 1) `supported` → включить; 2) `conditional` → включить с явными условиями/областью; 3) `uncertain/refuted` → исключить из основного текста, перенести в `Audit.md` с пояснением. Истинные противоречия разрешай в пользу тезиса с внешними подтверждениями/лучшей проверяемостью; альтернативный тезис — в раздел «опровергнуто/устарело». Телеграфные части разворачивай до полной аргументации, риторические — суши, сохраняя смысл. Для каждого абзаца укажи `[[C###, C###]]` — ссылки на источные тезисы.

**Каркас `Merged.md`.**
- Введение (1 абзац): предмет, рамки, ограничения.
- Корпус: разделы по тематическим кластерам; в каждом — тезис(ы), обоснование, границы.
- Заключение: остаточная неопределённость и открытые вопросы (с перекрёстными ссылками на `Audit.md`).

---

## 09. Auditor — аудит и журнал
**Вход.** Все артефакты.  
**Выход.** `Audit.md` + обновление `conflicts.md`.

**Инструкция.**
> Составь аудит: (i) что удалено как риторика — с указанием мест; (ii) какие тезисы отклонены и по какой причине (`refuted/uncertain/obsolete`); (iii) карта конфликтов и их разрешение; (iv) список «long‑tail» добавлений (редкие, но валидные) с источниками; (v) открытые вопросы и идеи для последующей проверки.

**Формат `Audit.md`.** Табличные блоки и краткие пояснения; обязательны ссылки на идентификаторы `C###`.

---

## 10. QA/Validator — финальная валидация
**Вход.** Все артефакты, особенно `Merged.md` и `Audit.md`.  
**Выход.** Отчёт о готовности.

**Инструкция.**
> Проверь корректность перекрёстных ссылок, полноту статусов, отсутствие «подвешенных» конфликтов; согласованность терминов с `term_map.tsv`; соответствие структуры текста целям документа. Укажи конкретные места для исправления (по id/странице/абзацу). Итог: `готово` или `нужны правки` с перечислением блокеров.

---

## Шаблоны файлов (минимальные шапки)

`claims.tsv`  
`id	claim	evidence_inline	scope.time	scope.jurisdiction	scope.conditions	facts	origin	notes`

`term_map.tsv`  
`canonical	variants	lang	definition_source	notes`

`pairs.tsv`  
`pair_id	A_id	B_id	matched_keys	scope_overlap	relation	nli	rationale	conflict_type	condition_notes`

`judgments.tsv`  
`pair_id	winner	C1	C2	C3	C4	notes`

`evidence.tsv`  
`claim_id	question	status	source	date	quote`

`consistency.tsv`  
`claim_id	variants_diff	unstable_facts	decision`

---

## Микропротоколы и пороги
- **A/B‑рандомизация.** Оркестратор вручную переставляет порядок, ведёт лог инверсий. Минимум 2 прогона на конфликтную пару.
- **Включение «long‑tail».** Требуется ≥1 первичный источник или ≥2 независимых вторичных + логическая совместимость. В противном случае — в `Audit.md` как «перспектива».
- **Стоп для синтеза.** Если `uncertain` > 10% в кластере — сначала до‑проверка (CoVe), затем повторное судейство.

---

## Переход к полукоду (Cursor/Agent): рекомендации по миграции
- Один агент‑Оркестратор + «инструменты» как подпроцессы (Extractor/Normalizer/Aligner/Judge/Verifier/SelfCheck/Synthesizer/Auditor/QA).  
- Хранилище: структура папок как в артефактах; наблюдение за изменениями файлов (`watch`) для триггеров подпроцессов.  
- Жёсткие интерфейсы ввода/вывода как в шапках TSV.  
- Первой автоматизировать Blocking/Aligner и CoVe‑логгинг; затем — генерацию `Merged.md` с валидацией ссылок.

---

## Краткая инструкция запуска (бумажная версия)
1) Extractor из каждого источника ⇒ черновой `claims.tsv`.  
2) Normalizer ⇒ `claims.tsv` (норм.) + `term_map.tsv`.  
3) Blocking ⇒ `pairs.tsv` (канд.).  
4) Aligner/NLI ⇒ `pairs.tsv` (с отношениями) + `conflicts.md`.  
5) Judge (двойной прогон) ⇒ `judgments.tsv`.  
6) Verifier (CoVe) ⇒ `evidence.tsv`.  
7) SelfCheck ⇒ `consistency.tsv`.  
8) Synthesizer ⇒ `Merged.md`.  
9) Auditor ⇒ `Audit.md`.  
10) QA ⇒ отчёт, правки при необходимости.

**Готовность к миграции.** После одного полного цикла зафиксируйте версии промптов, пороги и определения в `term_map.tsv` — это станет спецификацией для реализации в Cursor.

